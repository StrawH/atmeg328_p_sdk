/*
 * external_dac.c
 *
 *  Created on: Jul 29, 2019
 *      Author: mohamed
 */
#define F_CPU  16000000UL
#include <util/delay.h>
#include "../utils/custom_types.h"
#include "../mcal/spi/spi.h"
#include "../mcal/dio/mcal_dio.h"
const u16_t signal[]=
{
		2000 ,2012 ,2025 ,2037 ,2050 ,2062 ,2075 ,2088 ,2100 ,2113 ,2125 ,2138 ,2150 ,2163 ,2175 ,2188 ,2200 ,2213 ,2225 ,2238 ,2250 ,2263 ,2275 ,2288 ,2300 ,2313 ,2325 ,2338 ,2350 ,2362 ,2375 ,2387 ,2399 ,2412 ,2424 ,2436 ,2448 ,2461 ,2473 ,2485 ,2497 ,2510 ,2522 ,2534 ,2546 ,2558 ,2570 ,2582 ,2594 ,2606 ,2618 ,2630 ,2642 ,2654 ,2666 ,2678 ,2689 ,2701 ,2713 ,2725 ,2736 ,2748 ,2760 ,2771 ,2783 ,2795 ,2806 ,2818 ,2829 ,2840 ,2852 ,2863 ,2875 ,2886 ,2897 ,2908 ,2920 ,2931 ,2942 ,2953 ,2964 ,2975 ,2986 ,2997 ,3008 ,3019 ,3029 ,3040 ,3051 ,3061 ,3072 ,3083 ,3093 ,3104 ,3114 ,3125 ,3135 ,3145 ,3156 ,3166 ,3176 ,3186 ,3196 ,3206 ,3216 ,3226 ,3236 ,3246 ,3256 ,3266 ,3275 ,3285 ,3295 ,3304 ,3314 ,3323 ,3333 ,3342 ,3351 ,3361 ,3370 ,3379 ,3388 ,3397 ,3406 ,3415 ,3424 ,3432 ,3441 ,3450 ,3459 ,3467 ,3476 ,3484 ,3493 ,3501 ,3509 ,3517 ,3526 ,3534 ,3542 ,3550 ,3558 ,3565 ,3573 ,3581 ,3589 ,3596 ,3604 ,3611 ,3619 ,3626 ,3633 ,3641 ,3648 ,3655 ,3662 ,3669 ,3676 ,3682 ,3689 ,3696 ,3703 ,3709 ,3716 ,3722 ,3728 ,3735 ,3741 ,3747 ,3753 ,3759 ,3765 ,3771 ,3777 ,3783 ,3788 ,3794 ,3799 ,3805 ,3810 ,3815 ,3821 ,3826 ,3831 ,3836 ,3841 ,3846 ,3851 ,3855 ,3860 ,3865 ,3869 ,3873 ,3878 ,3882 ,3886 ,3890 ,3894 ,3898 ,3902 ,3906 ,3910 ,3914 ,3917 ,3921 ,3924 ,3928 ,3931 ,3934 ,3937 ,3940 ,3943 ,3946 ,3949 ,3952 ,3955 ,3957 ,3960 ,3962 ,3965 ,3967 ,3969 ,3971 ,3973 ,3975 ,3977 ,3979 ,3981 ,3982 ,3984 ,3986 ,3987 ,3988 ,3990 ,3991 ,3992 ,3993 ,3994 ,3995 ,3996 ,3996 ,3997 ,3998 ,3998 ,3999 ,3999 ,3999 ,3999 ,3999 ,3999 ,3999 ,3999 ,3999 ,3999 ,3998 ,3998 ,3997 ,3997 ,3996 ,3995 ,3994 ,3994 ,3993 ,3991 ,3990 ,3989 ,3988 ,3986 ,3985 ,3983 ,3982 ,3980 ,3978 ,3976 ,3974 ,3972 ,3970 ,3968 ,3966 ,3963 ,3961 ,3958 ,3956 ,3953 ,3951 ,3948 ,3945 ,3942 ,3939 ,3936 ,3933 ,3929 ,3926 ,3923 ,3919 ,3915 ,3912 ,3908 ,3904 ,3900 ,3896 ,3892 ,3888 ,3884 ,3880 ,3876 ,3871 ,3867 ,3862 ,3858 ,3853 ,3848 ,3843 ,3838 ,3833 ,3828 ,3823 ,3818 ,3813 ,3807 ,3802 ,3797 ,3791 ,3785 ,3780 ,3774 ,3768 ,3762 ,3756 ,3750 ,3744 ,3738 ,3732 ,3725 ,3719 ,3712 ,3706 ,3699 ,3693 ,3686 ,3679 ,3672 ,3665 ,3658 ,3651 ,3644 ,3637 ,3630 ,3622 ,3615 ,3607 ,3600 ,3592 ,3585 ,3577 ,3569 ,3561 ,3554 ,3546 ,3538 ,3530 ,3521 ,3513 ,3505 ,3497 ,3488 ,3480 ,3471 ,3463 ,3454 ,3446 ,3437 ,3428 ,3419 ,3410 ,3401 ,3392 ,3383 ,3374 ,3365 ,3356 ,3347 ,3337 ,3328 ,3318 ,3309 ,3299 ,3290 ,3280 ,3271 ,3261 ,3251 ,3241 ,3231 ,3221 ,3211 ,3201 ,3191 ,3181 ,3171 ,3161 ,3151 ,3140 ,3130 ,3119 ,3109 ,3099 ,3088 ,3077 ,3067 ,3056 ,3045 ,3035 ,3024 ,3013 ,3002 ,2991 ,2980 ,2969 ,2958 ,2947 ,2936 ,2925 ,2914 ,2903 ,2891 ,2880 ,2869 ,2858 ,2846 ,2835 ,2823 ,2812 ,2800 ,2789 ,2777 ,2766 ,2754 ,2742 ,2731 ,2719 ,2707 ,2695 ,2684 ,2672 ,2660 ,2648 ,2636 ,2624 ,2612 ,2600 ,2588 ,2576 ,2564 ,2552 ,2540 ,2528 ,2516 ,2503 ,2491 ,2479 ,2467 ,2455 ,2442 ,2430 ,2418 ,2405 ,2393 ,2381 ,2368 ,2356 ,2344 ,2331 ,2319 ,2306 ,2294 ,2282 ,2269 ,2257 ,2244 ,2232 ,2219 ,2207 ,2194 ,2182 ,2169 ,2157 ,2144 ,2131 ,2119 ,2106 ,2094 ,2081 ,2069 ,2056 ,2044 ,2031 ,2018 ,2006 ,1993 ,1981 ,1968 ,1955 ,1943 ,1930 ,1918 ,1905 ,1893 ,1880 ,1868 ,1855 ,1842 ,1830 ,1817 ,1805 ,1792 ,1780 ,1767 ,1755 ,1742 ,1730 ,1717 ,1705 ,1693 ,1680 ,1668 ,1655 ,1643 ,1631 ,1618 ,1606 ,1594 ,1581 ,1569 ,1557 ,1544 ,1532 ,1520 ,1508 ,1496 ,1483 ,1471 ,1459 ,1447 ,1435 ,1423 ,1411 ,1399 ,1387 ,1375 ,1363 ,1351 ,1339 ,1327 ,1315 ,1304 ,1292 ,1280 ,1268 ,1257 ,1245 ,1233 ,1222 ,1210 ,1199 ,1187 ,1176 ,1164 ,1153 ,1141 ,1130 ,1119 ,1108 ,1096 ,1085 ,1074 ,1063 ,1052 ,1041 ,1030 ,1019 ,1008 ,997 ,986 ,975 ,964 ,954 ,943 ,932 ,922 ,911 ,900 ,890 ,880 ,869 ,859 ,848 ,838 ,828 ,818 ,808 ,798 ,788 ,778 ,768 ,758 ,748 ,738 ,728 ,719 ,709 ,700 ,690 ,681 ,671 ,662 ,652 ,643 ,634 ,625 ,616 ,607 ,598 ,589 ,580 ,571 ,562 ,553 ,545 ,536 ,528 ,519 ,511 ,502 ,494 ,486 ,478 ,469 ,461 ,453 ,445 ,438 ,430 ,422 ,414 ,407 ,399 ,392 ,384 ,377 ,369 ,362 ,355 ,348 ,341 ,334 ,327 ,320 ,313 ,306 ,300 ,293 ,287 ,280 ,274 ,267 ,261 ,255 ,249 ,243 ,237 ,231 ,225 ,219 ,214 ,208 ,202 ,197 ,192 ,186 ,181 ,176 ,171 ,166 ,161 ,156 ,151 ,146 ,141 ,137 ,132 ,128 ,123 ,119 ,115 ,111 ,107 ,103 ,99 ,95 ,91 ,87 ,84 ,80 ,76 ,73 ,70 ,66 ,63 ,60 ,57 ,54 ,51 ,48 ,46 ,43 ,41 ,38 ,36 ,33 ,31 ,29 ,27 ,25 ,23 ,21 ,19 ,17 ,16 ,14 ,13 ,11 ,10 ,9 ,8 ,6 ,5 ,5 ,4 ,3 ,2 ,2 ,1 ,1 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,0 ,1 ,1 ,2 ,3 ,3 ,4 ,5 ,6 ,7 ,8 ,9 ,11 ,12 ,13 ,15 ,17 ,18 ,20 ,22 ,24 ,26 ,28 ,30 ,32 ,34 ,37 ,39 ,42 ,44 ,47 ,50 ,53 ,56 ,59 ,62 ,65 ,68 ,71 ,75 ,78 ,82 ,85 ,89 ,93 ,97 ,101 ,105 ,109 ,113 ,117 ,121 ,126 ,130 ,134 ,139 ,144 ,148 ,153 ,158 ,163 ,168 ,173 ,178 ,184 ,189 ,194 ,200 ,205 ,211 ,216 ,222 ,228 ,234 ,240 ,246 ,252 ,258 ,264 ,271 ,277 ,283 ,290 ,296 ,303 ,310 ,317 ,323 ,330 ,337 ,344 ,351 ,358 ,366 ,373 ,380 ,388 ,395 ,403 ,410 ,418 ,426 ,434 ,441 ,449 ,457 ,465 ,473 ,482 ,490 ,498 ,506 ,515 ,523 ,532 ,540 ,549 ,558 ,567 ,575 ,584 ,593 ,602 ,611 ,620 ,629 ,638 ,648 ,657 ,666 ,676 ,685 ,695 ,704 ,714 ,724 ,733 ,743 ,753 ,763 ,773 ,783 ,793 ,803 ,813 ,823 ,833 ,843 ,854 ,864 ,874 ,885 ,895 ,906 ,916 ,927 ,938 ,948 ,959 ,970 ,980 ,991 ,1002 ,1013 ,1024 ,1035 ,1046 ,1057 ,1068 ,1079 ,1091 ,1102 ,1113 ,1124 ,1136 ,1147 ,1159 ,1170 ,1181 ,1193 ,1204 ,1216 ,1228 ,1239 ,1251 ,1263 ,1274 ,1286 ,1298 ,1310 ,1321 ,1333 ,1345 ,1357 ,1369 ,1381 ,1393 ,1405 ,1417 ,1429 ,1441 ,1453 ,1465 ,1477 ,1489 ,1502 ,1514 ,1526 ,1538 ,1551 ,1563 ,1575 ,1587 ,1600 ,1612 ,1624 ,1637 ,1649 ,1661 ,1674 ,1686 ,1699 ,1711 ,1724 ,1736 ,1749 ,1761 ,1774 ,1786 ,1799 ,1811 ,1824 ,1836 ,1849 ,1861 ,1874 ,1886 ,1899 ,1911 ,1924 ,1937 ,1949 ,1962 ,1974 ,1987 ,1999

};
void dac_output(u16_t val);
void external_dac()
{
	u16_t counter = 0;
	_delay_ms(100);
	dio_set_channel_direction(dio_channel_rb0 , output);
	dio_set_channel_state(dio_channel_rb0 , high);
	init_spi(SPI_MASTER_OSC_DIV128 , SPI_CLK_IDLE_LOW , SPI_SAMPLE_RAISING_EDGE);
	while(1)
	{
		for(counter = 0; counter <1000 ; counter++ )
		{
			dac_output(signal[counter]); // 4096
		}
	}

}
void dac_output(u16_t val) {

  u8_t tmp;
  dio_set_channel_state(dio_channel_rb0 , low);
  // Send High Byte
  tmp = (val >> 8) & 0x0F;
  tmp |= 0x30;
  spi_write(tmp);
  // H L
  tmp = (u8_t)val;
  spi_write(tmp);
  dio_set_channel_state(dio_channel_rb0 , high);
}

